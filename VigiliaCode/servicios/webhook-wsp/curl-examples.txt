# Ejemplos de uso del WhatsApp Webhook - VigilIA

## Configuración Inicial

# Obtener API Key desde GCP
$API_KEY = gcloud secrets versions access latest --secret="webhook-api-key"
$URL = "https://whatsapp-webhook-687053793381.southamerica-west1.run.app"

## Ejemplo 1: Enviar Alerta de Caída

curl -X POST "$URL/send-notification" \
  -H "X-API-Key: $API_KEY" \
  -H "Content-Type: application/json; charset=utf-8" \
  -d '{
    "phone_number": "56912345678",
    "notification_type": "fall_alert",
    "title": "Alerta de Caída",
    "body": "Posible caída detectada",
    "parameters": {
      "nombre_adulto_mayor": "María González"
    }
  }'

## Ejemplo 2: Usar Template Directamente

curl -X POST "$URL/send-template" \
  -H "X-API-Key: $API_KEY" \
  -H "Content-Type: application/json; charset=utf-8" \
  -d '{
    "to": "56912345678",
    "template_name": "alertacaidatest",
    "language_code": "es_CL"
  }'

## Ejemplo 3: Enviar Mensaje de Texto Simple
# NOTA: Solo funciona después de que el usuario inicie conversación

curl -X POST "$URL/send-text" \
  -H "X-API-Key: $API_KEY" \
  -H "Content-Type: application/json; charset=utf-8" \
  -d '{
    "to": "56912345678",
    "message": "Mensaje de prueba desde VigilIA"
  }'

## Ejemplo 4: Payload Completo a Meta API (Referencia)

# Este es el formato exacto que se envía a Meta WhatsApp API
{
  "messaging_product": "whatsapp",
  "to": "56912345678",
  "type": "template",
  "template": {
    "name": "alertacaidatest",
    "language": {
      "code": "es_CL"
    },
    "components": [
      {
        "type": "body",
        "parameters": [
          {
            "type": "text",
            "parameter_name": "nombre",
            "text": "María González"
          }
        ]
      }
    ]
  }
}

## Verificar Logs

# Ver últimos 50 logs del servicio
gcloud run services logs read whatsapp-webhook \
  --region southamerica-west1 \
  --limit 50

# Ver logs en tiempo real
gcloud run services logs tail whatsapp-webhook \
  --region southamerica-west1

## Actualizar Secrets

# Actualizar token de WhatsApp (SIN newline)
echo -n "NUEVO_TOKEN_AQUI" | gcloud secrets versions add whatsapp-token --data-file=-

# Forzar servicio a usar nueva versión del secret
gcloud run services update whatsapp-webhook \
  --region southamerica-west1 \
  --update-secrets=WHATSAPP_TOKEN=whatsapp-token:11
