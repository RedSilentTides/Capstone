2025-11-14 01:58:39 ? Token interno verificado correctamente
2025-11-14 01:58:39 Buscando o creando dispositivo con identificador_hw: bec1a2c71301
2025-11-14 01:58:39 ? Dispositivo encontrado con ID num?rico: 1, Adulto Mayor ID: 1
2025-11-14 01:58:39 INFO:     169.254.169.126:16718 - "POST /dispositivos/get-or-create HTTP/1.1" 200 OK
2025-11-14 01:58:43 POST 200 https://api-backend-687053793381.southamerica-west1.run.app/dispositivos/get-or-create
2025-11-14 01:58:43 ? DEBUG: Token recibido: '2O7F6HfduZUKon5IxPwYeghAX3RlpViC' (len: 32)
2025-11-14 01:58:43 ? DEBUG: Token esperado: '2O7F6HfduZUKon5IxPwYeghAX3RlpViC' (len: 32)
2025-11-14 01:58:43 ? Token interno verificado correctamente
2025-11-14 01:58:43 Buscando o creando dispositivo con identificador_hw: bec1a2c71301
2025-11-14 01:58:43 ? Dispositivo encontrado con ID num?rico: 1, Adulto Mayor ID: 1
2025-11-14 01:58:43 INFO:     169.254.169.126:37822 - "POST /dispositivos/get-or-create HTTP/1.1" 200 OK
2025-11-14 01:58:46 POST 200 https://api-backend-687053793381.southamerica-west1.run.app/dispositivos/get-or-create
2025-11-14 01:58:46 ? DEBUG: Token recibido: '2O7F6HfduZUKon5IxPwYeghAX3RlpViC' (len: 32)
2025-11-14 01:58:46 ? DEBUG: Token esperado: '2O7F6HfduZUKon5IxPwYeghAX3RlpViC' (len: 32)
2025-11-14 01:58:46 ? Token interno verificado correctamente
2025-11-14 01:58:46 Buscando o creando dispositivo con identificador_hw: bec1a2c71301
2025-11-14 01:58:46 ? Dispositivo encontrado con ID num?rico: 1, Adulto Mayor ID: 1
2025-11-14 01:58:46 INFO:     169.254.169.126:37828 - "POST /dispositivos/get-or-create HTTP/1.1" 200 OK
2025-11-14 01:58:56 POST 200 https://api-backend-687053793381.southamerica-west1.run.app/dispositivos/get-or-create
2025-11-14 01:58:56 ? DEBUG: Token recibido: '2O7F6HfduZUKon5IxPwYeghAX3RlpViC' (len: 32)
2025-11-14 01:58:56 ? DEBUG: Token esperado: '2O7F6HfduZUKon5IxPwYeghAX3RlpViC' (len: 32)
2025-11-14 01:58:56 ? Token interno verificado correctamente
2025-11-14 01:58:56 Buscando o creando dispositivo con identificador_hw: bec1a2c71301
2025-11-14 01:58:56 ? Dispositivo encontrado con ID num?rico: 1, Adulto Mayor ID: 1
2025-11-14 01:58:56 INFO:     169.254.169.126:12318 - "POST /dispositivos/get-or-create HTTP/1.1" 200 OK
2025-11-14 01:58:56 OPTIONS 200 https://api-backend-687053793381.southamerica-west1.run.app/usuarios/yo
2025-11-14 01:58:56 INFO:     169.254.169.126:12322 - "OPTIONS /usuarios/yo HTTP/1.1" 200 OK
2025-11-14 01:58:56 OPTIONS 200 https://api-backend-687053793381.southamerica-west1.run.app/recordatorios
2025-11-14 01:58:56 OPTIONS 200 https://api-backend-687053793381.southamerica-west1.run.app/solicitudes-cuidado/recibidas
2025-11-14 01:58:56 OPTIONS 200 https://api-backend-687053793381.southamerica-west1.run.app/alertas
2025-11-14 01:58:56 INFO:     169.254.169.126:12324 - "OPTIONS /recordatorios HTTP/1.1" 200 OK
2025-11-14 01:58:56 OPTIONS 200 https://api-backend-687053793381.southamerica-west1.run.app/usuarios/yo
2025-11-14 01:58:56 INFO:     169.254.169.126:12326 - "OPTIONS /solicitudes-cuidado/recibidas HTTP/1.1" 200 OK
2025-11-14 01:58:56 INFO:     169.254.169.126:12342 - "OPTIONS /alertas HTTP/1.1" 200 OK
2025-11-14 01:58:56 INFO:     169.254.169.126:12344 - "OPTIONS /usuarios/yo HTTP/1.1" 200 OK
2025-11-14 01:58:56 GET 200 https://api-backend-687053793381.southamerica-west1.run.app/alertas
2025-11-14 01:58:56 GET 200 https://api-backend-687053793381.southamerica-west1.run.app/recordatorios
2025-11-14 01:58:56 GET 200 https://api-backend-687053793381.southamerica-west1.run.app/solicitudes-cuidado/recibidas
2025-11-14 01:58:56 GET 200 https://api-backend-687053793381.southamerica-west1.run.app/usuarios/yo
2025-11-14 01:58:56 Buscando perfil para firebase_uid: KweEiHhKPZbapIdSnH6zGKQYPXf2
2025-11-14 01:58:56 ? Perfil encontrado para KweEiHhKPZbapIdSnH6zGKQYPXf2, rol: cuidador
2025-11-14 01:58:56 Buscando perfil para firebase_uid: KweEiHhKPZbapIdSnH6zGKQYPXf2
2025-11-14 01:58:56 Buscando perfil para firebase_uid: KweEiHhKPZbapIdSnH6zGKQYPXf2
2025-11-14 01:58:56 Buscando perfil para firebase_uid: KweEiHhKPZbapIdSnH6zGKQYPXf2
2025-11-14 01:58:56 ? Perfil encontrado para KweEiHhKPZbapIdSnH6zGKQYPXf2, rol: cuidador
2025-11-14 01:58:56 ? Perfil encontrado para KweEiHhKPZbapIdSnH6zGKQYPXf2, rol: cuidador
2025-11-14 01:58:56 Obteniendo recordatorios para usuario_id: 1, rol: cuidador, filtro adulto_mayor_id: None
2025-11-14 01:58:56 Obteniendo solicitudes recibidas para usuario 1
2025-11-14 01:58:56 ? Perfil encontrado para KweEiHhKPZbapIdSnH6zGKQYPXf2, rol: cuidador
2025-11-14 01:58:56 ? Encontrados 2 recordatorios.
2025-11-14 01:58:56 ? Encontradas 0 solicitudes recibidas.
2025-11-14 01:58:56 INFO:     169.254.169.126:12372 - "GET /usuarios/yo HTTP/1.1" 200 OK
2025-11-14 01:58:56 INFO:     169.254.169.126:12366 - "GET /recordatorios HTTP/1.1" 200 OK
2025-11-14 01:58:56 INFO:     169.254.169.126:12354 - "GET /alertas HTTP/1.1" 200 OK
2025-11-14 01:58:56 INFO:     169.254.169.126:12370 - "GET /solicitudes-cuidado/recibidas HTTP/1.1" 200 OK
2025-11-14 01:58:56 GET 200 https://api-backend-687053793381.southamerica-west1.run.app/usuarios/yo
2025-11-14 01:58:56 Buscando perfil para firebase_uid: KweEiHhKPZbapIdSnH6zGKQYPXf2
2025-11-14 01:58:56 ? Perfil encontrado para KweEiHhKPZbapIdSnH6zGKQYPXf2, rol: cuidador
2025-11-14 01:58:56 INFO:     169.254.169.126:12384 - "GET /usuarios/yo HTTP/1.1" 200 OK
2025-11-14 01:59:01 POST 200 https://api-backend-687053793381.southamerica-west1.run.app/dispositivos/get-or-create
2025-11-14 01:59:01 ? DEBUG: Token recibido: '2O7F6HfduZUKon5IxPwYeghAX3RlpViC' (len: 32)
2025-11-14 01:59:01 ? DEBUG: Token esperado: '2O7F6HfduZUKon5IxPwYeghAX3RlpViC' (len: 32)
2025-11-14 01:59:01 ? Token interno verificado correctamente
2025-11-14 01:59:01 Buscando o creando dispositivo con identificador_hw: bec1a2c71301
2025-11-14 01:59:01 ? Dispositivo encontrado con ID num?rico: 1, Adulto Mayor ID: 1
2025-11-14 01:59:01 INFO:     169.254.169.126:35990 - "POST /dispositivos/get-or-create HTTP/1.1" 200 OK
2025-11-14 01:59:01 OPTIONS 200 https://api-backend-687053793381.southamerica-west1.run.app/alertas/122?confirmado=true&notas=Ayuda+en+camino
2025-11-14 01:59:01 INFO:     169.254.169.126:35994 - "OPTIONS /alertas/122?confirmado=true&notas=Ayuda+en+camino HTTP/1.1" 200 OK
2025-11-14 01:59:01 PUT 500 https://api-backend-687053793381.southamerica-west1.run.app/alertas/122?confirmado=true&notas=Ayuda+en+camino
2025-11-14 01:59:01 Buscando perfil para firebase_uid: KweEiHhKPZbapIdSnH6zGKQYPXf2
2025-11-14 01:59:01 ? Perfil encontrado para KweEiHhKPZbapIdSnH6zGKQYPXf2, rol: cuidador
2025-11-14 01:59:01 INFO:     169.254.169.126:36008 - "PUT /alertas/122?confirmado=true&notas=Ayuda+en+camino HTTP/1.1" 500 Internal Server Error
2025-11-14 01:59:01 ERROR:    Exception in ASGI application
2025-11-14 01:59:01 Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
psycopg2.errors.SyntaxError: syntax error at or near ":"
2025-11-14 01:59:01 LINE 5: ... = COALESCE(detalles_adicionales, '{}'::jsonb) || :detalles_...
2025-11-14 01:59:01                                                              ^
2025-11-14 01:59:01 The above exception was the direct cause of the following exception:
2025-11-14 01:59:01 Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/uvicorn/protocols/http/h11_impl.py", line 403, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/fastapi/applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "/usr/local/lib/python3.11/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/usr/local/lib/python3.11/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py", line 93, in __call__
    await self.simple_response(scope, receive, send, request_headers=headers)
  File "/usr/local/lib/python3.11/site-packages/starlette/middleware/cors.py", line 144, in simple_response
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.11/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.11/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/usr/local/lib/python3.11/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 125, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/usr/local/lib/python3.11/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 111, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 391, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/fastapi/routing.py", line 292, in run_endpoint_function
    return await run_in_threadpool(dependant.call, **values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/starlette/concurrency.py", line 38, in run_in_threadpool
    return await anyio.to_thread.run_sync(func)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/anyio/to_thread.py", line 56, in run_sync
    return await get_async_backend().run_sync_in_worker_thread(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 2485, in run_sync_in_worker_thread
    return await future
           ^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/anyio/_backends/_asyncio.py", line 976, in run
    result = context.run(func, *args)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/main.py", line 2680, in actualizar_alerta
    result = db_conn.execute(query_update, {
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
           ^^^^^
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
  File "/usr/local/lib/python3.11/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
sqlalchemy.exc.ProgrammingError: (psycopg2.errors.SyntaxError) syntax error at or near ":"
2025-11-14 01:59:01 LINE 5: ... = COALESCE(detalles_adicionales, '{}'::jsonb) || :detalles_...
2025-11-14 01:59:01                                                              ^
2025-11-14 01:59:01 [SQL: 
2025-11-14 01:59:01                 UPDATE alertas
2025-11-14 01:59:01                 SET confirmado_por_cuidador = %(confirmado)s,
2025-11-14 01:59:01                     notas = %(notas)s,
2025-11-14 01:59:01                     detalles_adicionales = COALESCE(detalles_adicionales, '{}'::jsonb) || :detalles_update::jsonb
2025-11-14 01:59:01                 WHERE id = %(alerta_id)s
2025-11-14 01:59:01                 RETURNING id, adulto_mayor_id, tipo_alerta, timestamp_alerta,
2025-11-14 01:59:01                           dispositivo_id, url_video_almacenado,
2025-11-14 01:59:01                           confirmado_por_cuidador, notas, detalles_adicionales, fecha_registro
2025-11-14 01:59:01             ]
2025-11-14 01:59:01 [parameters: {'confirmado': True, 'notas': 'Ayuda en camino', 'alerta_id': 122}]
2025-11-14 01:59:01 (Background on this error at: https://sqlalche.me/e/20/f405)
2025-11-14 01:59:01 OPTIONS 200 https://api-backend-687053793381.southamerica-west1.run.app/mensajes
2025-11-14 01:59:01 INFO:     169.254.169.126:36018 - "OPTIONS /mensajes HTTP/1.1" 200 OK
2025-11-14 01:59:01 POST 404 https://api-backend-687053793381.southamerica-west1.run.app/mensajes
2025-11-14 01:59:01 INFO:     169.254.169.126:36030 - "POST /mensajes HTTP/1.1" 404 Not Found
2025-11-14 01:59:01 OPTIONS 200 https://api-backend-687053793381.southamerica-west1.run.app/notificaciones/enviar
2025-11-14 01:59:01 INFO:     169.254.169.126:36034 - "OPTIONS /notificaciones/enviar HTTP/1.1" 200 OK
2025-11-14 01:59:01 POST 404 https://api-backend-687053793381.southamerica-west1.run.app/notificaciones/enviar
2025-11-14 01:59:01 INFO:     169.254.169.126:36042 - "POST /notificaciones/enviar HTTP/1.1" 404 Not Found
[]
